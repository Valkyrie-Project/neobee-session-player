name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ${{ runner.os }}-pods-
          
    - name: Install CocoaPods dependencies
      run: |
        sudo gem install cocoapods
        pod install --repo-update
        
    - name: Run tests
      run: |
        xcodebuild test \
          -workspace neobee-session-player.xcworkspace \
          -scheme neobee-session-player \
          -destination 'platform=macOS' \
          -configuration Debug
          
    - name: Build Archive
      run: |
        xcodebuild archive \
          -workspace neobee-session-player.xcworkspace \
          -scheme neobee-session-player \
          -configuration Release \
          -archivePath ./build/NeoBee-KTV-Player.xcarchive \
          -destination 'generic/platform=macOS'
          
    - name: Create ExportOptions.plist
      run: |
        mkdir -p ./build
        cat > ./build/ExportOptions.plist << EOF
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>method</key>
            <string>developer-id</string>
            <key>destination</key>
            <string>export</string>
            <key>signingStyle</key>
            <string>automatic</string>
            <key>stripSwiftSymbols</key>
            <true/>
        </dict>
        </plist>
        EOF
        
    - name: Export Archive
      run: |
        xcodebuild -exportArchive \
          -archivePath ./build/NeoBee-KTV-Player.xcarchive \
          -exportPath ./build/export \
          -exportOptionsPlist ./build/ExportOptions.plist || \
        echo "Export failed, creating unsigned build..."
        
    - name: Create DMG (fallback)
      run: |
        # å¦‚æœå¯¼å‡ºå¤±è´¥ï¼Œç›´æ¥ä»archiveä¸­æå–app
        if [ ! -d "./build/export" ]; then
          mkdir -p ./build/export
          cp -R "./build/NeoBee-KTV-Player.xcarchive/Products/Applications/NeoBee KTVæ’­æ”¾å™¨.app" "./build/export/"
        fi
        
        # åˆ›å»ºDMG
        ./create_dmg.sh --skip-test || echo "DMG creation completed with warnings"
        
    - name: Get version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/}
        else
          VERSION="dev-$(date +%Y%m%d-%H%M%S)"
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: |
          NeoBee-KTV-Player.dmg
        name: "NeoBee KTV Session Player ${{ steps.version.outputs.VERSION }}"
        body: |
          ## ğŸ¤ NeoBee KTV Session Player ${{ steps.version.outputs.VERSION }}
          
          ### åŠŸèƒ½ç‰¹æ€§
          - æ”¯æŒ MKV å’Œ MPG æ ¼å¼ KTV æ–‡ä»¶
          - åŸå”±/ä¼´å¥éŸ³è½¨åˆ‡æ¢
          - KTV é£æ ¼å…¨å±ç•Œé¢
          - æ’­æ”¾é˜Ÿåˆ—ç®¡ç†
          
          ### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ `NeoBee-KTV-Player.dmg`
          2. åŒå‡»æ‰“å¼€ DMG æ–‡ä»¶
          3. å°†åº”ç”¨æ‹–æ‹½åˆ° Applications æ–‡ä»¶å¤¹
          4. å³é”®ç‚¹å‡»åº”ç”¨é€‰æ‹©"æ‰“å¼€"ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰
          
          ### ç³»ç»Ÿè¦æ±‚
          - macOS 15.5 æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ”¯æŒ Intel å’Œ Apple Silicon Mac
        draft: false
        prerelease: ${{ contains(steps.version.outputs.VERSION, 'dev') || contains(steps.version.outputs.VERSION, 'alpha') || contains(steps.version.outputs.VERSION, 'beta') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-artifacts-${{ steps.version.outputs.VERSION }}
        path: |
          ./build/
          NeoBee-KTV-Player.dmg
        retention-days: 30
