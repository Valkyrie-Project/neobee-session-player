name: Test Build Environment

on:
  workflow_dispatch:

jobs:
  test-environment:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check macOS environment
      run: |
        echo "ğŸ–¥ï¸ macOSç‰ˆæœ¬:"
        sw_vers
        echo ""
        echo "ğŸ’¾ ç£ç›˜ç©ºé—´:"
        df -h
        echo ""
        echo "ğŸ”§ Xcodeç‰ˆæœ¬:"
        xcode-select -p
        xcodebuild -version
        echo ""
        echo "ğŸ“± å¯ç”¨çš„æ¨¡æ‹Ÿå™¨:"
        xcrun simctl list devices available | head -20
        
    - name: Check CocoaPods
      run: |
        echo "ğŸ’ CocoaPodsç‰ˆæœ¬:"
        gem list cocoapods
        echo ""
        echo "ğŸ” æ£€æŸ¥Podfile:"
        if [ -f "Podfile" ]; then
          echo "âœ… Podfileå­˜åœ¨"
          cat Podfile
        else
          echo "âŒ Podfileä¸å­˜åœ¨"
        fi
        
    - name: Test CocoaPods install
      run: |
        echo "ğŸ“¦ å®‰è£…CocoaPodsä¾èµ–..."
        sudo gem install cocoapods --no-document || echo "CocoaPodså·²å®‰è£…"
        pod install --repo-update
        echo "âœ… CocoaPodså®‰è£…å®Œæˆ"
        
    - name: Test basic build
      run: |
        echo "ğŸ”¨ æµ‹è¯•åŸºç¡€æ„å»º..."
        xcodebuild -list -workspace neobee-session-player.xcworkspace
        echo ""
        echo "ğŸ§ª æµ‹è¯•ç¼–è¯‘ï¼ˆä¸è¿è¡Œï¼‰:"
        xcodebuild build \
          -workspace neobee-session-player.xcworkspace \
          -scheme neobee-session-player \
          -configuration Debug \
          -destination 'generic/platform=macOS' \
          -quiet
        echo "âœ… åŸºç¡€æ„å»ºæµ‹è¯•é€šè¿‡"
        
    - name: Test archive creation
      run: |
        echo "ğŸ“¦ æµ‹è¯•Archiveåˆ›å»º..."
        xcodebuild archive \
          -workspace neobee-session-player.xcworkspace \
          -scheme neobee-session-player \
          -configuration Release \
          -archivePath ./test.xcarchive \
          -destination 'generic/platform=macOS' \
          -quiet
        echo "âœ… Archiveåˆ›å»ºæµ‹è¯•é€šè¿‡"
        
        echo "ğŸ“Š Archiveä¿¡æ¯:"
        ls -la ./test.xcarchive/
        if [ -d "./test.xcarchive/Products/Applications" ]; then
          echo "âœ… åº”ç”¨ç¨‹åºå·²ç”Ÿæˆ"
          ls -la "./test.xcarchive/Products/Applications/"
        else
          echo "âŒ åº”ç”¨ç¨‹åºæœªç”Ÿæˆ"
        fi
