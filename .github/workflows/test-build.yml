name: Test Build Environment

on:
  workflow_dispatch:

jobs:
  test-environment:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Check macOS environment
      run: |
        echo "🖥️ macOS版本:"
        sw_vers
        echo ""
        echo "💾 磁盘空间:"
        df -h
        echo ""
        echo "🔧 Xcode版本:"
        xcode-select -p
        xcodebuild -version
        echo ""
        echo "📱 可用的模拟器:"
        xcrun simctl list devices available | head -20
        
    - name: Check CocoaPods
      run: |
        echo "💎 CocoaPods版本:"
        gem list cocoapods
        echo ""
        echo "🔍 检查Podfile:"
        if [ -f "Podfile" ]; then
          echo "✅ Podfile存在"
          cat Podfile
        else
          echo "❌ Podfile不存在"
        fi
        
    - name: Test CocoaPods install
      run: |
        echo "📦 安装CocoaPods依赖..."
        sudo gem install cocoapods --no-document || echo "CocoaPods已安装"
        pod install --repo-update
        echo "✅ CocoaPods安装完成"
        
    - name: Test basic build
      run: |
        echo "🔨 测试基础构建..."
        xcodebuild -list -workspace neobee-session-player.xcworkspace
        echo ""
        echo "🧪 测试编译（不运行）:"
        xcodebuild build \
          -workspace neobee-session-player.xcworkspace \
          -scheme neobee-session-player \
          -configuration Debug \
          -destination 'generic/platform=macOS' \
          -quiet
        echo "✅ 基础构建测试通过"
        
    - name: Test archive creation
      run: |
        echo "📦 测试Archive创建..."
        xcodebuild archive \
          -workspace neobee-session-player.xcworkspace \
          -scheme neobee-session-player \
          -configuration Release \
          -archivePath ./test.xcarchive \
          -destination 'generic/platform=macOS' \
          -quiet
        echo "✅ Archive创建测试通过"
        
        echo "📊 Archive信息:"
        ls -la ./test.xcarchive/
        if [ -d "./test.xcarchive/Products/Applications" ]; then
          echo "✅ 应用程序已生成"
          ls -la "./test.xcarchive/Products/Applications/"
        else
          echo "❌ 应用程序未生成"
        fi
